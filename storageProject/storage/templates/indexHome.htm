{% load static %}

<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storage Register</title>
    <link rel="icon" type="image/png" href="{% static 'FavIcon.svg'%}">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="{% static 'style.css'%}" />
    <link rel="stylesheet" href="{% static 'style2.css'%}" />
    <link rel="stylesheet" href="{% static 'bootstrap.css'%}" />

    <!-- google fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <title>Home</title>

</head>

<body>
    <!-- First Nav (Top nav) -->
    <nav class="navbar navbar-expand-lg bg-white py-4 sticky-top container-lg">
        <div class="container-fluid">
            <div class="col-6 col-sm-4 col-md-3 col-xl-2 ms-4 ms-lg-0">
                <img src="{% static 'NavLogo.png' %}" class="img-fluid col-7 mt-2 ">
            </div>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" ariag-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <div class="col-lg-7 col-sm-10 col-11 mx-auto my-4">
                    <div class="input-group my-auto rounded-5 px-2 search-box py-1 ">
                        <form method="post" action="{% url 'search_file' %}" class="d-block w-100 row d-flex nowrap">
                            {% csrf_token %}
                            {{ form.query.label_tag }}
                        <div class="input-group-prepend col-2">
                            <button class="m-2 d-inline-block bg-transparent border-0" type="submit">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <ellipse cx="9.16667" cy="9.16667" rx="6.66667" ry="6.66667" stroke="#333F4E"
                                        stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></ellipse>
                                    <path d="M13.75 14.1308L17.9167 18.2975" stroke="#333F4E" stroke-width="1.5"
                                        stroke-linecap="round" stroke-linejoin="round"></path>
                                </svg>


                            </button>
                        </div>
                        <input type="text" name="query" class="form-control rounded-5 border-0 w-75" placeholder="Search ..."
                            aria-label="" aria-describedby="basic-addon1">
                        </form>
                    </div>

                </div>
                <div class="col-lg-5 col-12">
                    <div class="row">
                        <div class="col-lg-6 col-md-4 col-3 col-6 mx-auto d-flex">
                            <button class="btn-second py-sm-2 py-1 poppins-semibold fs-input px-3 mx-auto"
                                data-bs-toggle="modal" data-bs-target="#uploadModal">
                                <div>
                                    <svg width="21" height="16" viewBox="0 0 21 16" fill="none"
                                        xmlns="http://www.w3.org/2000/svg" class="my-auto">
                                        <path
                                            d="M16.1273 15.2771H11.8363V10.9412H13.2544C13.614 10.9412 13.8265 10.5325 13.614 10.2383L10.8555 6.42138C10.6798 6.17618 10.3161 6.17618 10.1404 6.42138L7.3819 10.2383C7.16939 10.5325 7.37781 10.9412 7.74152 10.9412H9.15958V15.2771H4.3537C2.20821 15.1586 0.5 13.1521 0.5 10.978C0.5 9.47818 1.31324 8.17046 2.5188 7.46347C2.40846 7.16515 2.35125 6.84639 2.35125 6.51129C2.35125 4.9788 3.5895 3.74055 5.12199 3.74055C5.453 3.74055 5.77176 3.79776 6.07009 3.9081C6.95689 2.02825 8.86943 0.724609 11.0926 0.724609C13.9696 0.728696 16.3398 2.93139 16.6095 5.73891C18.8204 6.11897 20.5 8.16638 20.5 10.4835C20.5 12.96 18.5711 15.1055 16.1273 15.2771Z"
                                            fill="white"></path>
                                    </svg>
                                    <p class="d-inline mt-1">Upload</p>
                                </div>

                            </button>
                        </div>
                        <div class="col-lg-6 col-md-4 col-4 col-6 mx-auto d-flex justify-content-center">
                            <img src="{% static 'ImageUser.png' %}" class="rounded-circle col-2 my-auto">
                            <p class="poppins-semibold d-inline mx-2 my-auto">
                                {{ user_info.username }}
                            </p>
                        </div>


                    </div>
                </div>


            </div>
        </div>
    </nav>

    <!-- upload Modal-->
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content rounded-5 border-0">
                <div class="modal-header my-2">
                    <button type="button" class="btn-close-modal ms-2 rounded-circle shadow" data-bs-dismiss="modal"
                        aria-label="Close"><img src="/static/modalAddPeople/Arrow-left.png" class="img-fluid"></button>
                    <h1 class="w-50 modal-title fs-6 poppins-semibold color-text-main header-position-modal"
                        id="staticBackdropLabel">Upload File</h1>

                </div>

                <div class="modal-body">
                    <img src="{% static 'Search.png' %}" class="img-fluid w-50 d-block mx-auto">

                    <form action="/upload/" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <br>
                        <input type="file" name="file"><br><br>
                        <button class="btn-second py-sm-2 py-1 poppins-semibold fs-input w-100"
                            type="submit">Upload</button>
                    </form>

                </div>
            </div>
        </div>
    </div>
    <!-- End upload Modal-->

    <div class="container-lg bg-gray mt-2">
        <!-- Title Objects and space -->
        <div class="row" style="margin-left: 20px;margin-right: 20px">
            <h1 class="color-text-main poppins-bold mt-4">Objects</h1>
            <p class="color-text-main">Total: <b title="{{ total_size }}" id="totalSize">{{ total_size }}</b></p>
        </div>
        <!-- Objects Section -->
        <div class="row mb-4" style="margin-left: 20px;margin-right: 20px">
            
        
                 <!-- object shared_files + files -->

        {% for file in page_obj %}
        <div id="obj-{{ file.id }}" class="col-xl-3 col-lg-4 col-sm-6 col-11 mx-auto mx-md-0 d-flex my-2">
            <div class="bg-white m-auto col-12 rounded-4">
                <div class="row">
                    <div class="col-4 d-flex justify-content-end">
                        <div class="circle-bg-icon-object rounded-circle d-flex text-end my-2">
                            {% if file.file_type == "image/png" or file.file_type == "image/jpeg" %}
                            <img src="{% static 'objectIcons/Image.png' %}" class="img-fluid w-50 m-auto">
                            {% elif file.file_type == "application/pdf" %}
                            <img src="{% static 'objectIcons/LogoPDF.png' %}" class="img-fluid w-50 m-auto">
                            {% elif file.file_type == "audio/mpeg" %}
                            <img src="{% static 'objectIcons/Music.png' %}" class="img-fluid w-50 m-auto">
                            {% elif file.file_type == "video/mp4" %}
                            <img src="{% static 'objectIcons/Video.png' %}" class="img-fluid w-50 m-auto">
                            {% else %}
                            <img src="{% static 'objectIcons/OthersFile.png' %}" class="img-fluid w-50 m-auto">
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-6 d-flex flex-column justify-content-center">
                        <h2 title="{{ file.file_name }}"
                            class="poppins-semibold fs-6 color-text-main mb-1 overflow-hidden w-100 overflow-detail-object">
                            {{ file.file_name }}</h2>
                        <p class="poppins-semibold fs-7 color-text-second m-0 mt-1 overflow-hidden w-100 overflow-detail-object">
                            <span id="size" title="{{ file.size }}">{{ file.size }}</span> - <span
                                title="{{ file.upload_date }}">{{ file.upload_date }}</span>
                        </p>
                    </div>
                    <button class="col-2 border-0 d-flex btn" type="button" data-bs-toggle="dropdown" aria-expanded="True">
                        <img class="img-fluid my-auto img-object-option" src="{% static 'objectIcons/Option.png' %}" alt="">
                    </button>
                    <div class="dropdown-menu col-5 col-md-4 col-lg-3 col-xl-2 col-2 shadow border-0 rounded-5">
                        <div class="container py-2">
                            <h3 class="fs-6 poppins-semibold color-text-main ms-2 mt-2 mb-3">{{ file.file_name }}</h3>
                            
                            {% if file.type == "owned" %}
                            <button type="button" class="color-text-main fs-6 btn w-100 text-start py-0"
                                data-bs-toggle="modal" data-bs-target="#modal-{{ file.id }}" title="Access management">
                                <img class="img-fluid col-2" src="{% static 'popoverIcons/share.png' %}"><span
                                    class="ms-2">Share</span>
                            </button>
                            
        
                            <hr class="m-2">
                            {% endif %}
                            <button onclick="document.location='{% url 'download_file' file.id %}'" type="button"
                                class="color-text-main fs-6 btn w-100 text-start py-0">
                                <img class="img-fluid col-2" src="{% static 'popoverIcons/download.png' %}"><span
                                    class="ms-2">Download</span>
                            </button>
                            {% if file.type == "owned" %}
                            <hr class="m-2">
        
                            <button onclick="document.location='{% url 'delete_file' file.id %}'" type="button"
                                class="color-text-main fs-6 btn w-100 text-start py-0">
                                <img class="img-fluid col-2" src="{% static 'popoverIcons/Delete.png' %}"><span
                                    class="ms-2">Delete</span>
                            </button>
                            {% endif %}

                        </div>
                    </div>
                </div>
            </div>
        </div>
        

             <script>
            document.addEventListener('DOMContentLoaded', (event) => {
    const divElement = document.getElementById('obj-{{ file.id }}');
    const buttonElement = divElement.querySelector('button[data-bs-toggle="dropdown"]');

    divElement.addEventListener('contextmenu', function(e) {
        e.preventDefault();  // از نمایش منوی راست کلیک پیش‌فرض مرورگر جلوگیری می‌کند
        buttonElement.click();  // شبیه‌سازی کلیک روی دکمه
    });
});
        </script>


        <!-- Modal -->
        <div class="modal fade" id="modal-{{ file.id }}" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
            aria-labelledby="staticBackdropLabel-{{ file.id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog modal-dialog-scrollable">
                <div class="modal-content rounded-5 border-0">
                    <div class="modal-header my-2">
                        <button type="button" class="btn-close-modal ms-2 rounded-circle shadow" data-bs-dismiss="modal"
                            aria-label="Close"><img src="{% static 'modalAddPeople/Arrow-left.png' %}"
                                class="img-fluid"></button>
                        <h1 class="w-50 modal-title fs-6 poppins-semibold color-text-main header-position-modal"
                            id="staticBackdropLabel-{{ file.id }}">Add People</h1>
                    </div>
                    <div class="modal-body">
                        <!-- Search Div-->
                        <div class="col-12 ">
                            <div class="input-group my-auto rounded-5 px-2 search-box py-1 ">
                                <div class="input-group-prepend">
                                    <a class="m-2 d-inline-block" type="button">
                                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <ellipse cx="9.16667" cy="9.16667" rx="6.66667" ry="6.66667" stroke="#333F4E"
                                                stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></ellipse>
                                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></ellipse>
                                            <path d="M13.75 14.1308L17.9167 18.2975" stroke="#333F4E" stroke-width="1.5"
                                                stroke-linecap="round" stroke-linejoin="round"></path>
                                        </svg>
                                    </a>
                                </div>
                                <input id="user-search" type="text" class="form-control rounded-5 border-0 " placeholder="Search ..."
                                    aria-label="" aria-describedby="basic-addon1">
                            </div>
                        </div>
                        <!-- Select People -->
        
                        <form method="post" action="{% url 'save_selected_users' %}" id="userForm-{{ file.id }}" >
                            {% csrf_token %}
                            {% for user in file.shared_with.all %}
        
                                <input type="hidden" name="file_id" value="{{ file.id }}">
        
                            <div class="row d-flex justify-content-end my-3">
                                <div class="col-2 col-sm-1 d-flex h">
                                    <input class="form-check-input m-auto" type="checkbox" name="selected_users"
                                        value="{{ user.id }}" id="flexCheckDefault" checked >
                                </div>
                                <div class="col-2">
                                    <img src="{% static 'modalAddPeople/Image.png' %}" class="rounded-circle img-fluid w-75">
                                </div>
                                <div class="col-8">
                                    <p class="m-0 poppins-semibold color-text-main fs-6">{{ user.username }}</p>
                                    <p class="m-0 poppins-regular color-text-gray fs-7">{{ user.email }}</p>
        
                                </div>
                            </div>
                            {% endfor %}
                        {% for user in users %}
                            {% if user not in file.shared_with.all %}
                                <input type="hidden" name="file_id" value="{{ file.id }}">
                            <div class="row d-flex justify-content-end my-3">
                                <div class="col-2 col-sm-1 d-flex h">
                                    <input class="form-check-input m-auto" type="checkbox" name="selected_users"
                                        value="{{ user.id }}" id="flexCheckDefault">
                                </div>
                                <div class="col-2">
                                    <img src="{% static 'modalAddPeople/Image.png' %}" class="rounded-circle img-fluid w-75">
                                </div>
                                <div class="col-8">
        
                                    <p class="m-0 poppins-semibold color-text-main fs-6">{{ user.username }}</p>
                                    <p class="m-0 poppins-regular color-text-gray fs-7">{{ user.email }}</p>
                                </div>
                            </div>
                        {% endif %}
                        {% endfor %}
        
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-second py-2 poppins-regular fs-7 px-3"
                            onclick="submitForm({{ file.id }})">Continue</button>
                    </div>
                </div>
            </div>
        </div>


        <script>
document.addEventListener('DOMContentLoaded', function() {
    // گرفتن مدال با شناسه خاص
    const modalId = 'modal-{{ file.id }}';
    const modal = document.getElementById(modalId);

    if (modal) {
        // گرفتن input جستجو و ردیف‌های کاربران داخل مدال
        const searchInput = modal.querySelector('#user-search');
        const userRows = modal.querySelectorAll('.row.d-flex.justify-content-end.my-3');

        if (searchInput) {
            // اضافه کردن رویداد input به input
            searchInput.addEventListener('input', function() {
                // گرفتن مقدار ورودی و تبدیل آن به حروف کوچک برای مقایسه بهتر
                const searchValue = searchInput.value.toLowerCase();

                // پیمایش از میان ردیف‌های کاربران
                userRows.forEach(function(row) {
                    // گرفتن نام کاربر و تبدیل آن به حروف کوچک برای مقایسه
                    const username = row.querySelector('.poppins-semibold.color-text-main.fs-6').textContent.toLowerCase();

                    // مقایسه نام کاربر با مقدار ورودی
                    if (username.includes(searchValue)) {
                        // نمایش ردیف اگر نام کاربر شامل مقدار ورودی باشد
                        row.style.setProperty('display', 'flex', 'important');
                    } else {
                        // پنهان کردن ردیف اگر نام کاربر شامل مقدار ورودی نباشد
                        row.style.setProperty('display', 'none', 'important');
                    }
                });
            });
        }
    }
});


        </script>

        {% endfor %}





        <nav aria-label="Page navigation" class="pt-3 mx-auto d-flex">
            <ul class="pagination mx-auto">
              {% if page_obj.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page=1" aria-label="First">
                    <span aria-hidden="true">&laquo; first</span>
                  </a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
                    <span aria-hidden="true">previous</span>
                  </a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <a class="page-link" href="#" aria-label="First">
                    <span aria-hidden="true">&laquo; first</span>
                  </a>
                </li>
                <li class="page-item disabled">
                  <a class="page-link" href="#" aria-label="Previous">
                    <span aria-hidden="true">previous</span>
                  </a>
                </li>
              {% endif %}
              
              <li class="page-item active">
                <a class="page-link" href="#">
                  Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                </a>
              </li>
              
              {% if page_obj.has_next %}
                <li class="page-item">
                  <a class="page-link " href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                    <span aria-hidden="true">next</span>
                  </a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}" aria-label="Last">
                    <span aria-hidden="true">last &raquo;</span>
                  </a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <a class="page-link" href="#" aria-label="Next">
                    <span aria-hidden="true">next</span>
                  </a>
                </li>
                <li class="page-item disabled">
                  <a class="page-link" href="#" aria-label="Last">
                    <span aria-hidden="true">last &raquo;</span>
                  </a>
                </li>
              {% endif %}
            </ul>
          </nav>
          



    <script>
    document.addEventListener("DOMContentLoaded", function() {
      // پیدا کردن تمامی عناصر span و b با id="size" و id="totalSize"
      var spans = document.querySelectorAll('span#size');
      var bolds = document.querySelectorAll('b#totalSize');

      function updateFileSize(elements) {
        elements.forEach(function(element) {
          // گرفتن مقدار file.size از ویژگی title
          var fileSizeInBytes = parseInt(element.getAttribute('title'), 10);
          var fileSizeFormatted;

          if (fileSizeInBytes < 1024) {
            // تبدیل اندازه فایل به بایت
            fileSizeFormatted = (fileSizeInBytes ).toFixed(2) + ' B';
          } else if (fileSizeInBytes < 1024 * 1024) {
            // تبدیل اندازه فایل به کیلوبایت
            fileSizeFormatted = (fileSizeInBytes / 1024).toFixed(2) + ' KB';
          } else if (fileSizeInBytes < 1024 * 1024 * 1024) {
            // تبدیل اندازه فایل به مگابایت
            fileSizeFormatted = (fileSizeInBytes / (1024 * 1024)).toFixed(2) + ' MB';
          } else {
            // تبدیل اندازه فایل به گیگابایت
            fileSizeFormatted = (fileSizeInBytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
          }

          // به‌روزرسانی ویژگی title و متن element
          element.setAttribute('title', fileSizeFormatted);
          element.innerText = fileSizeFormatted;
        });
      }

      updateFileSize(spans);
      updateFileSize(bolds);
    });

    function submitForm(id) {
                document.getElementById('userForm-'+id).submit();
            }
    {##}
    {#        document.addEventListener('DOMContentLoaded', (event) => {#}
    {#    const divElement = document.querySelector('.hihi');#}
    {#    const buttonElement = divElement.querySelector('button[data-bs-toggle="dropdown"]');#}
    {##}
    {#    divElement.addEventListener('contextmenu', function(e) {#}
    {#        e.preventDefault();  // از نمایش منوی راست کلیک پیش‌فرض مرورگر جلوگیری می‌کند#}
    {#        buttonElement.click();  // شبیه‌سازی کلیک روی دکمه#}
    {#    });#}
    {#});#}
    {##}




    function triggerButton(div) {
        // Find the button inside the clicked div
        let button = div.querySelector('button[data-bs-toggle="dropdown"]');
        // Simulate a click event on the button
        div.addEventListener('contextmenu', function(e) {
            e.preventDefault();  // از نمایش منوی راست کلیک پیش‌فرض مرورگر جلوگیری می‌کند
            button.click();  // شبیه‌سازی کلیک روی دکمه
        });

    }




  </script>


</body>


</html>